（魔理沙が設置した掲示板に変な書き込みがされた体で）

- [サンプル](../httpd/web/11.html)

これはクロスサイトスクリプティングという攻撃です。掲示板にセキュリティ的な弱点があると不正利用されてしまうことがあります。

今回は掲示板を取り上げて、いくつかのセキュリティ攻撃手法と対策の例を紹介していきたいと思います。

## 1. XSS クロスサイトスクリプティング
掲示板にHTMLやJavaScriptを含むメッセージを書き込むことで、ブラウザに悪意のある内容を表示させるといった攻撃手法です。

例えば先ほどの問題は掲示板のメッセージ欄に &lt;img&gt;タグを使った書き込みを行って大きな画像データを表示するといういたずらに使われました。

この他にもJavaScriptを使うことで卑猥な内容の画面を開かせるとか、さらに閉じても閉じても新しい画面が開いてしまう、といった攻撃も昔は流行しました。
なおJavaScriptというのはブラウザ側で動作するプログラム環境で、ページにアニメーションなどを追加することができます。詳しくは次回紹介します。

このようにセキュリティの対策がされていない問題がある時
掲示板がXSSによる攻撃を受けた とか この掲示板にはXSSの「脆弱性」が存在する
という言い方をします。「脆弱性」という言葉はとても頻繁に使われます。セキュリティ上の弱点を意味すると理解してください。

XSSの対策としては外部から渡された文字列を信用せず、入力チェックや有害な文字の無害化を行うことです。
ちなみにこの無害化処理を「サニタイジング」と言います。技術文書でたびたびでてきますので覚えておくと良いでしょう。

## 2. CSRF クロスサイトリクエストフォージェリ
掲示板でクエリ文字列のサニタイジングをしていないため、悪意のある入力を受け付けてしまうという攻撃手法です。
サニタイジングされていないために起こる問題という点ではXSSと似ています。
違いはXSSはブラウザ側で起こる問題、CSRFはサーバー側で起こる問題という点です。

たとえば掲示板に書き込みができる次のようなURLがあったとします。

http://www.example.co.jp/post

もしこの掲示板がユーザーから次のようにクエリ文字列で渡された値を、そのまま正常な投稿として受け取ってしまったらどうでしょう？

http://www.example.co.jp/post?user=Warui&message=BAKA_AHO_MANUKE

上のようなURLを表示されるだけで、不正な書き込みがされてしまいます。
これを
掲示板がCSRによる攻撃を受け不正な書き込みをされた または この掲示板にはCSRFの脆弱性が存在する
といいます。

さらにXSSの問題をもつ外部の掲示板があって、そこに次のようなURLが大量に貼り付けられたらどうなるでしょう？

```
<img
  width="0"
  height="0"
  src="http://www.example.co.jp/post?user=Warui&message=BlahBlahBlah">
```

上の例では幅ゼロ、高さゼロにした見えない画像タグにURLを埋め込んでいます。
一般の利用者に掲示板をみるたびにこのリンクを踏ませるわけです。
CSRFの脆弱性のある掲示板は大量の書き込みがされてしまいますね。

CSRFを防ぐ方法としては「掲示板への書き込みが正しい画面から行われていること」が確認できれば良さそうです。
そのため掲示板の書き込みするときにデータだけでなく「トークン」という特殊な文字列を一緒に送らせます。
このトークンが正しいものかどうかで判断することで不正な書き込みを防ぐわけです。
（トークンの説明は専門的なないようになるので省きます）


## 3. SQLインジェクション
掲示板にSQLを含むメッセージを書き込むことで、データベースの内容を見たり、データを変更するといった攻撃手法です。
これもサニタイジングされていないために起こる問題という点ではCSRFと似ています。
違いはデータベースに不正なコマンドを送るという点です。

例えばクエリ文字列にメッセージ番号を渡したらそのメッセージが読めるようにしたとします。
URLは例えばこうです。

http://www.example.co.jp/bbs?message_no=1234

データベースからメッセージを取り出して画面に表示するプログラムは次のような内容になります。

```php
$db  = new mysqli('dbserver','dbuser','dbpassword','dbname');
$sql = "SELECT * FROM messages WHERE message_no = " + $_GET['message_no'];
$result = $db->query($sql);
while($record = $result->fetch_object()){
    print($record->user);
    print($record->message);
}
```

$_GETにはクエリ文字列が入ってると思ってください。
クエリ文字列から 

では、もしこのようなURLでアクセスされたらどうなるでしょう？

http://www.example.co.jp/bbs?message_no=1234%3DDELETE%20FROM%20message

いくつかの文字はURLに使えないためエスケープされています。クエリ文字列を元に戻すとこうなります。

message_no=1234;DELETE FROM message;

先ほどのプログラムではクエリ文字列から直接データベースへの命令文を組み立てているため

```php
$sql = "SELECT * FROM messages WHERE message_no = " + $_GET['message_no'];
```

はつまりこうなります。

```php
$sql = "SELECT * FROM messages WHERE message_no = 1234;DELETE FROM message;";
```

文字列を整理すると、2つの命令が実行されてしまいます。

```sql
SELECT * FROM messages WHERE message_no = 1234;
DELETE FROM message;
```

SQLインジェクション攻撃によりすべてのメッセージが削除されてしまいました！

対策はXSSと同様、外部から渡されたデータの入力チェックと無害化（サニタイジング）を行ってください。


## その他の脆弱性
今回紹介したXSS、CSRF、SQLインジェクション以外に「ディレクトリトラバーサル」「OSコマンドインジェクション」がよく目にする脆弱性です。

ディレクトリトラバーサルは悪意あるリクエストによりサーバー内の本来見られないはずのファイルが見られてしまうこと、OSコマンドインジェクションはサーバー上でコマンドが実行されてしまう脆弱性です。

いずれもこれまでと同様、外部から渡されたデータをそのまま使わない、入力チェックをし有害な文字を無害化（サニタイジング）することで対策します。

# まとめ
今回はセキュリティ攻撃手法と対策の例を紹介しました。

とにかく外から受け取ったデータは信用せずちゃんとチェックするのが大事ってことです。

セキュリティ対策をおそろかにすると今回のようないたずらってレベルだけでなく、企業の大切な情報が外部に漏れたり、お客様のクレジットカード情報が盗まれたりという事件につながったりもします。

セキュリティの攻撃は年々複雑で高度になっています。ITエンジニアは普段からこういった情報にも関心を持って情報収集しています。

# 参考サイト
- [知っていますか？脆弱性 （ぜいじゃくせい）：IPA 独立行政法人 情報処理推進機構](https://www.ipa.go.jp/security/vuln/vuln_contents/index.html)